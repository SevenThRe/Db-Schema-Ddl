# MCP Audit (2026-02-27)

Scope: `mcp/index.ts`, parser integration, and comment/reference exploration flow.

Status update (same day):

- ✅ P1-1 implemented: regex safety constraints now enforce pattern-length cap, restricted flags, and runtime extraction guardrails (step/time/match budgets).
- ✅ P1-2 implemented: filter semantics are now configurable via `sourceMatchMode` and `codeIdMatchMode`, and are exposed in tool schema + response metadata.

## Executive summary

- ✅ Dedicated exploration tool has been separated from DDL generation (`query_comment_references`).
- ✅ Raw comment fidelity is preserved (`commentRaw`) while structured extraction remains additive.
- ✅ Parsing controls are configurable via `referenceExtraction` rules.
- ⚠️ Additional hardening and scalability improvements are still recommended (see P1/P2 items).

---

## What is good now

1. **Separation of concerns**
   - `parse_excel_to_ddl`: focused on parsing + DDL generation.
   - `query_comment_references`: focused on AI exploration and remark/reference retrieval.

2. **No information loss**
   - Original comment content remains available in `commentRaw`.
   - Structured references do not overwrite free-text remarks.

3. **Configurable extraction**
   - Regex rules (`source`, `pattern`, capture groups, flags) are caller-configurable.

4. **Filterability for AI workflows**
   - Exploration supports `sheetName`, `query`, `source`, `codeId`.
   - Supports pagination-style controls via `offset` + `maxResults`.

---

## Remaining risks / improvement points

### P1 (recommended next)

1. **Regex safety controls**
   - User-provided regex rules can cause heavy backtracking.
   - Recommendation:
     - Limit pattern length.
     - Reject unsupported flags.
     - Add runtime guard/timeout budget for extraction loops.

2. **Structured filter semantics**
   - ✅ Implemented:
     - `sourceMatchMode`: `exact` | `contains` (default: `exact`)
     - `codeIdMatchMode`: `contains` | `exact` | `starts_with` (default: `contains`)
   - Follow-up recommendation:
     - Consider optional case-sensitive mode when needed by strict governance queries.

3. **Result order contract**
   - Output order currently follows parse traversal order.
   - Recommendation:
     - Document deterministic sort key or apply explicit stable sorting.

### P2 (scalability / UX)

1. **Workbook-level caching for exploration**
   - `query_comment_references` scans may be expensive on large files.
   - Recommendation:
     - Reuse parsed workbook bundle aggressively and expose cache-hit metadata.

2. **Projection controls**
   - Rows can become large (long comments/options arrays).
   - Recommendation:
     - Add optional field projection controls, e.g. `includeRawComment`, `includeOptions`.

3. **Cross-sheet code index endpoint**
   - Many AI tasks need `codeId -> all table/column usage` quickly.
   - Recommendation:
     - Add optional index mode or a small dedicated endpoint for reverse mapping.

---

## Change log tied to this audit

- Promoted exploration to dedicated tool: `query_comment_references`.
- Kept `parse_excel_to_ddl` focused (removed heavy exploration payload from it).
- Added `offset` to exploration query for better pagination control.
- Updated MCP documentation to reflect the dedicated workflow.
